<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="js/constants.js"></script>
    <script src="js/storage.js"></script>
  </head>
  <body>
    <h3>Preferences</h3>

    <b>What cards to sync:</b>
    <select id="scope">
      <option value="none">All</option>
      <option value="me">Only assigned to me</option>
    </select>

    <b>Default difficulty for todos:</b>
    <select id="priority">
      <option value="0.5">Trivial</option>
      <option value="1">Easy</option>
      <option value="1.5">Medium</option>
      <option value="2">Hard</option>
    </select>

    <button id="submit-btn" class="mod-primary">Save</button><br>
    <button id="logout-btn" class="mod-danger">Log out</button>
  
    <script>
      let t = TrelloPowerUp.iframe()
      let storage = new Storage(t)
      let $submitButton = document.getElementById('submit-btn')
      let $logoutButton = document.getElementById('logout-btn')

      let $scope = document.getElementById('scope')
      let $priority = document.getElementById('priority')

      storage.getSettings().then(settings => {
        $scope.value = settings.scope
        $priority.value = settings.priority
      })

      $submitButton.addEventListener('click', async () => {
        $submitButton.disabled = true
        
        return storage.setSettings({ 
          scope: $scope.value,
          priority: $priority.value
        }).then(() => t.closePopup())
      })

      $logoutButton.addEventListener('click', async () => {
        $logoutButton.disabled = true

        return Promise.all([
          storage.removeUser()
        ]).then(() => { 
          return t.closePopup()
        })
      })

    </script>
  </body>
</html>